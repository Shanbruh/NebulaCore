
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>TITAN X | Ultimate P2P</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00f3ff; --bg: #08080a; }
        body {
            background-color: var(--bg);
            color: #d1d5db;
            font-family: 'JetBrains Mono', monospace;
            height: 100dvh; /* Dynamic Viewport Height for Mobile */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        /* Glassmorphism Refined */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
        }
        
        /* Sidebar Overlay Fix */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100dvh;
            width: 280px;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(5, 5, 7, 0.98);
            border-right: 1px solid rgba(0, 243, 255, 0.3);
            padding-top: calc(1rem + env(safe-area-inset-top));
        }
        #sidebar.open { transform: translateX(0); }

        /* Speed Glow */
        .neon-accent { color: var(--neon); text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); }
        .progress-bar { transition: width 0.15s linear; height: 100%; background: var(--neon); box-shadow: 0 0 15px var(--neon); }

        /* Mobile Adjustments */
        @media (max-width: 640px) {
            .page-container { padding: 1rem; }
            .stat-text { font-size: 0.75rem; }
        }

        .scroll-custom::-webkit-scrollbar { width: 4px; }
        .scroll-custom::-webkit-scrollbar-thumb { background: rgba(0, 243, 255, 0.2); border-radius: 10px; }
        
        .active-nav { border-left: 4px solid var(--neon); background: rgba(0, 243, 255, 0.05); color: var(--neon); }
    </style>
</head>
<body>

    <!-- Top HUD -->
    <header class="h-16 flex items-center px-4 md:px-8 bg-black/50 border-b border-white/5 z-[900] justify-between">
        <div class="flex items-center gap-4">
            <button id="menu-btn" class="p-2 hover:bg-white/5 rounded-lg text-neon">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <h1 class="orbitron text-lg tracking-widest hidden sm:block">TITAN<span class="text-white opacity-50">_X</span></h1>
        </div>
        
        <div class="flex items-center gap-6">
            <div class="text-right flex flex-col">
                <span id="bandwidth" class="text-xl font-bold neon-accent leading-none">0.00</span>
                <span class="text-[9px] uppercase opacity-40 tracking-tighter">MB/s Aggregate</span>
            </div>
            <div id="status-led" class="w-3 h-3 rounded-full bg-red-600 shadow-[0_0_8px_red]"></div>
        </div>
    </header>

    <!-- Side Navigation -->
    <nav id="sidebar">
        <div class="p-6 mt-12 flex flex-col gap-2">
            <p class="text-[10px] uppercase opacity-30 font-bold tracking-[0.3em] mb-4">Core Modules</p>
            <button onclick="navigate('bridge')" class="nav-btn w-full text-left p-4 uppercase text-xs font-bold tracking-widest transition-all">> Connection</button>
            <button onclick="navigate('comms')" class="nav-btn w-full text-left p-4 uppercase text-xs font-bold tracking-widest transition-all">> Messages</button>
            <button onclick="navigate('cargo')" class="nav-btn w-full text-left p-4 uppercase text-xs font-bold tracking-widest transition-all">> Cargo Hold</button>
            
            <div class="mt-auto pt-16 border-t border-white/5">
                <div class="glass-panel p-4">
                    <span class="text-[9px] uppercase opacity-40">Local Access Key</span>
                    <div id="my-id" class="text-xl font-bold text-white tracking-[0.2em] mt-1">...</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Viewport -->
    <main class="flex-grow overflow-y-auto overflow-x-hidden scroll-custom relative">
        
        <!-- Connection Page -->
        <section id="p-bridge" class="page-container h-full flex items-center justify-center p-6">
            <div class="max-w-md w-full glass-panel p-8 space-y-8">
                <div class="text-center">
                    <h2 class="orbitron text-sm uppercase opacity-60 tracking-[.5em]">Sync Handshake</h2>
                </div>
                <div class="space-y-4">
                    <input type="text" id="target-id" maxlength="3" 
                           class="w-full bg-black/40 border border-white/10 p-5 text-4xl text-center font-bold uppercase tracking-[0.8em] focus:outline-none focus:border-cyan-400 rounded-lg transition-all"
                           placeholder="---">
                    <button id="connect-btn" class="w-full bg-cyan-400 text-black py-5 text-xs font-bold uppercase tracking-widest hover:bg-white transition-all rounded-lg">Initialize Bridge</button>
                </div>
                <div class="p-3 bg-blue-900/10 border border-blue-400/20 text-[10px] text-blue-300 rounded leading-relaxed italic">
                    INFO: If using same Wi-Fi, Titan X will ignore relay nodes and bridge via local hardware at maximum speed.
                </div>
            </div>
        </section>

        <!-- Chat Page -->
        <section id="p-comms" class="page-container hidden h-full flex flex-col max-w-5xl mx-auto p-4 md:p-8">
            <div class="flex-grow glass-panel overflow-hidden flex flex-col mb-4">
                <div id="chat-stream" class="flex-grow p-6 overflow-y-auto text-xs space-y-3 opacity-90">
                    <div class="opacity-30 italic">[SYSTEM] Encrypted buffer ready.</div>
                </div>
                <form id="chat-form" class="p-4 bg-black/60 border-t border-white/5 flex gap-4">
                    <input type="text" id="chat-input" autocomplete="off" placeholder="ENTRY DATA..." 
                           class="flex-grow bg-transparent border-none text-sm text-cyan-400 focus:outline-none">
                    <button class="text-cyan-400 text-xs font-bold uppercase tracking-widest hover:text-white transition-colors">Send</button>
                </form>
            </div>
        </section>

        <!-- Files Page -->
        <section id="p-cargo" class="page-container hidden h-full max-w-3xl mx-auto p-4 md:p-8">
            <div id="drop-zone" class="glass-panel p-16 border-dashed border-2 border-white/10 hover:border-cyan-400 transition-all cursor-pointer flex flex-col items-center justify-center gap-6 group">
                <input type="file" id="file-input" class="hidden">
                <div class="w-20 h-20 rounded-full border border-white/5 flex items-center justify-center group-hover:scale-110 transition-all">
                    <svg class="w-10 h-10 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="1.5"/></svg>
                </div>
                <div class="text-center">
                    <p class="text-[10px] font-bold uppercase tracking-[0.5em]">Select Byte Stream</p>
                    <p class="text-[9px] opacity-30 mt-2">Zero-copy local transfer active</p>
                </div>
            </div>
            <div id="transfer-list" class="mt-8 space-y-4"></div>
        </section>

    </main>

    <script>
        // --- PERFORMANCE ENGINE CONFIG ---
        const CHUNK_SIZE = 124 * 1024; // Optimized for Chromium pipe
        const MAX_BUFFER = 2 * 1024 * 1024; // 2MB Sliding window
        const ab1Id = Math.random().toString(36).substr(2, 3).toUpperCase();
        
        let peer = null;
        let conn = null;
        let stats = { bytes: 0, start: 0 };
        let activeIncoming = null;

        document.getElementById('my-id').innerText = ab1Id;

        function init() {
            peer = new Peer('TITAN-X-' + ab1Id, {
                config: { 
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
                    iceTransportPolicy: 'all' // Allows direct LAN discovery
                }
            });

            peer.on('connection', (c) => {
                if(conn) return c.close();
                setupLink(c);
            });
        }

        function setupLink(c) {
            conn = c;
            conn.on('open', () => {
                document.getElementById('status-led').className = 'w-3 h-3 rounded-full bg-cyan-400 shadow-[0_0_10px_#00f3ff]';
                document.getElementById('connect-btn').innerText = 'BRIDGE_STABLE';
                log('System', 'Bridge Established. Optimization for LAN 6 enabled.');
            });

            conn.on('data', (data) => {
                if (data instanceof ArrayBuffer) {
                    processIncomingBytes(data);
                } else {
                    handleJson(data);
                }
            });

            conn.on('close', () => location.reload());
        }

        // --- ULTRA BOLT SENDER ---
        async function sendFile(file) {
            if(!conn?.open) return;
            const txId = Math.random().toString(36).substr(7);
            uiTransferCreate(file.name, txId);
            
            // Meta packet
            conn.send({ type: 'm', id: txId, n: file.name, s: file.size, t: file.type });

            let offset = 0;
            stats.start = Date.now();
            stats.bytes = 0;

            const sendNext = () => {
                // High-performance backpressure monitoring
                while (offset < file.size && conn.dataChannel.bufferedAmount < MAX_BUFFER) {
                    const chunk = file.slice(offset, offset + CHUNK_SIZE);
                    const reader = new FileReader();
                    const currentOffset = offset;
                    
                    reader.onload = (e) => {
                        conn.send(e.target.result);
                        stats.bytes += e.target.result.byteLength;
                        
                        // Performance: Throttle UI updates to once per 10 chunks to save CPU
                        if(currentOffset % (CHUNK_SIZE * 10) === 0) {
                            uiUpdateProgress(txId, (currentOffset / file.size) * 100);
                            updateHUD();
                        }

                        if (currentOffset + CHUNK_SIZE >= file.size) {
                            conn.send({ type: 'e', id: txId });
                            uiUpdateProgress(txId, 100);
                            updateHUD();
                            log('System', 'Transfer sequence complete.');
                        }
                    };
                    reader.readAsArrayBuffer(chunk);
                    offset += CHUNK_SIZE;
                }
                
                if (offset < file.size) setTimeout(sendNext, 4); // Minimal delay for browser event loop
            };
            sendNext();
        }

        function processIncomingBytes(buf) {
            if (!activeIncoming) return;
            activeIncoming.c.push(buf);
            activeIncoming.r += buf.byteLength;
            stats.bytes += buf.byteLength;
            
            if(activeIncoming.r % (CHUNK_SIZE * 10) === 0) {
                uiUpdateProgress(activeIncoming.i, (activeIncoming.r / activeIncoming.s) * 100);
                updateHUD();
            }
        }

        function handleJson(msg) {
            if (msg.type === 'msg') log('Remote', msg.d);
            if (msg.type === 'm') {
                activeIncoming = { i: msg.id, n: msg.n, s: msg.s, c: [], r: 0 };
                uiTransferCreate(msg.n, msg.id, true);
                stats.start = Date.now();
                stats.bytes = 0;
            }
            if (msg.type === 'e') {
                const blob = new Blob(activeIncoming.c);
                const a = document.getElementById('dl-' + activeIncoming.i);
                a.href = URL.createObjectURL(blob);
                a.download = activeIncoming.n;
                a.classList.remove('hidden');
                uiUpdateProgress(activeIncoming.i, 100);
                activeIncoming = null;
            }
        }

        // --- INTERFACE CONTROL ---
        function navigate(pageId) {
            document.querySelectorAll('.page-container').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active-nav'));
            
            document.getElementById('p-' + pageId).classList.remove('hidden');
            const targetBtn = Array.from(document.querySelectorAll('.nav-btn')).find(b => b.onclick.toString().includes(pageId));
            if(targetBtn) targetBtn.classList.add('active-nav');
            
            if(window.innerWidth < 1024) toggleSidebar();
        }

        const sidebar = document.getElementById('sidebar');
        function toggleSidebar() { sidebar.classList.toggle('open'); }
        document.getElementById('menu-btn').onclick = toggleSidebar;

        function log(who, msg) {
            const out = document.getElementById('chat-stream');
            out.innerHTML += `<div><span class="text-cyan-400 opacity-60 font-bold uppercase mr-2">${who}:</span> <span>${msg}</span></div>`;
            out.scrollTop = out.scrollHeight;
        }

        function uiTransferCreate(name, id, isInc) {
            const list = document.getElementById('transfer-list');
            const div = document.createElement('div');
            div.className = 'glass-panel p-4 flex flex-col gap-3 relative overflow-hidden';
            div.innerHTML = `
                <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest z-10">
                    <span class="truncate w-1/2">${name}</span>
                    <span id="p-${id}">0.0%</span>
                </div>
                <div class="h-1 bg-white/5 w-full rounded-full overflow-hidden">
                    <div id="b-${id}" class="progress-bar w-0"></div>
                </div>
                <a id="dl-${id}" class="hidden block text-center bg-cyan-400 text-black text-[9px] font-bold mt-2 py-2 uppercase tracking-[0.2em] rounded">Get Binary</a>
            `;
            list.prepend(div);
        }

        function uiUpdateProgress(id, p) {
            const b = document.getElementById('b-' + id);
            const t = document.getElementById('p-' + id);
            if(b) b.style.width = p + '%';
            if(t) t.innerText = p.toFixed(1) + '%';
        }

        function updateHUD() {
            const dt = (Date.now() - stats.start) / 1000;
            if (dt > 0.5) {
                const speed = ((stats.bytes / 1024 / 1024) / dt).toFixed(2);
                document.getElementById('bandwidth').innerText = speed;
            }
        }

        document.getElementById('connect-btn').onclick = () => {
            const tid = document.getElementById('target-id').value.toUpperCase();
            if(tid) setupLink(peer.connect('TITAN-X-' + tid, { reliable: true }));
        };

        document.getElementById('chat-form').onsubmit = e => {
            e.preventDefault();
            const val = document.getElementById('chat-input').value;
            if (val && conn?.open) {
                conn.send({ type: 'msg', d: val });
                log('Local', val);
                document.getElementById('chat-input').value = '';
            }
        };

        document.getElementById('drop-zone').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = e => { if(e.target.files[0]) sendFile(e.target.files[0]); };

        window.onload = () => { navigate('bridge'); init(); };
    </script>
</body>
</html>
