
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN LAN-MAX | 100MB/s Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00ffaa; --bg: #020202; }
        body { background: var(--bg); color: var(--neon); font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(0, 255, 170, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(0, 255, 170, 0.2); }
        .sidebar { transition: 0.4s cubic-bezier(0.1, 0.9, 0.2, 1); transform: translateX(-100%); z-index: 1000; background: #000; border-right: 1px solid var(--neon); }
        .sidebar.open { transform: translateX(0); }
        .speed-text { font-family: 'Orbitron', sans-serif; text-shadow: 0 0 10px var(--neon); }
        @keyframes flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .active-btn { background: var(--neon); color: #000; box-shadow: 0 0 20px var(--neon); }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <!-- HUD Header -->
    <header class="h-20 border-b border-[#00ffaa33] flex items-center px-6 justify-between bg-black z-[1001]">
        <div class="flex items-center gap-5">
            <button id="menu-toggle" class="text-2xl hover:scale-110 transition-transform">â˜°</button>
            <div class="flex flex-col">
                <span class="text-xs tracking-[0.5em] opacity-50">LAN_MODE_ACTIVE</span>
                <span class="font-bold text-xl uppercase tracking-tighter speed-text">Titan_v5</span>
            </div>
        </div>
        <div class="flex items-center gap-8">
            <div class="text-right">
                <span id="stat-speed" class="speed-text text-2xl">0.00</span>
                <span class="text-[10px] block opacity-50">MB/S BANDWIDTH</span>
            </div>
            <div id="connection-bulb" class="w-3 h-3 rounded-full bg-red-900 border border-red-500"></div>
        </div>
    </header>

    <!-- Side Menu -->
    <nav id="sidebar" class="fixed inset-y-0 left-0 w-72 pt-28 px-8 sidebar">
        <div class="flex flex-col gap-8">
            <button onclick="nav('base')" class="text-left text-sm font-bold tracking-widest hover:text-white transition-colors">>_ BRIDGE_INIT</button>
            <button onclick="nav('comms')" class="text-left text-sm font-bold tracking-widest hover:text-white transition-colors">>_ COMMS_LOG</button>
            <button onclick="nav('dump')" class="text-left text-sm font-bold tracking-widest hover:text-white transition-colors">>_ CARGO_DUMP</button>
            <div class="mt-20 p-4 border border-[#00ffaa44]">
                <div class="text-[9px] opacity-40 uppercase">LOCAL_HEX_ID</div>
                <div id="my-id-display" class="text-xl font-bold text-white tracking-widest">---</div>
            </div>
        </div>
    </nav>

    <!-- Content -->
    <main class="flex-grow p-6 flex flex-col items-center justify-center relative">
        
        <!-- BRIDGE PAGE -->
        <section id="page-base" class="page active w-full max-w-sm">
            <div class="glass p-10 space-y-8 rounded-lg relative">
                <div class="absolute -top-3 left-4 bg-black px-2 text-[10px] text-white">CONNECTION_PROTOCOL</div>
                <input type="text" id="target-id" maxlength="3" 
                       class="w-full bg-transparent border-b-2 border-[#00ffaa55] py-4 text-4xl text-center font-bold focus:outline-none focus:border-[#00ffaa] transition-all uppercase tracking-[0.5em]"
                       placeholder="KEY">
                <button id="connect-btn" class="w-full border-2 border-[#00ffaa] py-4 text-xs font-bold uppercase tracking-[0.3em] hover:bg-[#00ffaa] hover:text-black transition-all">Establish Link</button>
                <div class="text-[9px] text-center opacity-40">FORCE_DIRECT_ICE_ENABLED</div>
            </div>
        </section>

        <!-- COMMS PAGE -->
        <section id="page-comms" class="page w-full max-w-2xl h-[70vh] glass flex flex-col rounded-lg overflow-hidden">
            <div id="chat-messages" class="flex-grow p-6 overflow-y-auto text-xs space-y-2 opacity-80"></div>
            <form id="chat-form" class="p-4 bg-black border-t border-[#00ffaa33] flex">
                <input type="text" id="chat-input" autocomplete="off" placeholder="ENTRY_MESSAGE..." class="flex-grow bg-transparent border-none text-[#00ffaa] text-sm focus:outline-none">
            </form>
        </section>

        <!-- CARGO PAGE -->
        <section id="page-dump" class="page w-full max-w-xl space-y-6">
            <div id="drop-zone" class="glass p-16 border-dashed border-2 border-[#00ffaa44] hover:bg-[#00ffaa11] transition-all cursor-pointer text-center group">
                <input type="file" id="file-input" class="hidden">
                <span class="text-xs font-bold block mb-2 uppercase tracking-[0.5em]">Initiate Byte Stream</span>
                <span class="text-[10px] opacity-30 mt-2 block">DROP_FILE_HERE_FOR_LAN_FORCE</span>
            </div>
            <div id="tx-log" class="space-y-3 max-h-64 overflow-y-auto pr-2"></div>
        </section>

    </main>

    <script>
        // --- LAN PERFORMANCE CONFIGURATION ---
        const CHUNK_SIZE = 128 * 1024; // 128KB Chunks
        const BUFFER_SAFE_ZONE = 2 * 1024 * 1024; // 2MB Throttle point
        const AB1_ID = Math.random().toString(36).substr(2, 3).toUpperCase();
        
        let peer = null;
        let conn = null;
        let stats = { bytes: 0, start: 0 };

        document.getElementById('my-id-display').innerText = AB1_ID;

        function init() {
            // Force direct connection by explicitly setting ICE policy
            peer = new Peer('TITAN5-' + AB1_ID, {
                config: {
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
                    iceTransportPolicy: 'all' // Allows both Relay and Host (LAN)
                }
            });

            peer.on('connection', c => {
                if (conn) return c.close();
                setupBridge(c);
            });
        }

        function setupBridge(c) {
            conn = c;
            conn.on('open', () => {
                document.getElementById('connection-bulb').style.backgroundColor = '#00ffaa';
                document.getElementById('connection-bulb').style.boxShadow = '0 0 10px #00ffaa';
                document.getElementById('connect-btn').innerText = 'BRIDGE_ACTIVE';
                log('SYSTEM', 'Link established. Local IP discovery prioritized.');
            });

            conn.on('data', data => {
                if (data instanceof ArrayBuffer) {
                    processBytes(data);
                } else {
                    handleJson(data);
                }
            });
            
            conn.on('close', () => location.reload());
        }

        // --- MAX SPEED SENDER ---
        async function sendFile(file) {
            if (!conn?.open) return;
            const txId = Math.random().toString(36).substr(7);
            uiCreate(file.name, txId);
            
            // Meta handshake
            conn.send({ type: 'meta', id: txId, name: file.name, size: file.size, mime: file.type });

            let offset = 0;
            stats.start = Date.now();
            stats.bytes = 0;

            const stream = () => {
                // Adaptive Throttle: Keeps the pipe perfectly full without overflow
                while (offset < file.size && conn.dataChannel.bufferedAmount < BUFFER_SAFE_ZONE) {
                    const chunk = file.slice(offset, offset + CHUNK_SIZE);
                    const reader = new FileReader();
                    
                    // Closure capture for offsets
                    const currentOffset = offset;
                    reader.onload = e => {
                        conn.send(e.target.result);
                        stats.bytes += e.target.result.byteLength;
                        uiUpdate(txId, (currentOffset / file.size) * 100);
                        updateSpeed();
                        
                        if (currentOffset + CHUNK_SIZE >= file.size) {
                            conn.send({ type: 'end', id: txId });
                            log('SYSTEM', 'Payload delivered.');
                        }
                    };
                    reader.readAsArrayBuffer(chunk);
                    offset += CHUNK_SIZE;
                }
                
                if (offset < file.size) {
                    setTimeout(stream, 1); // Yield to browser briefly then resume
                }
            };
            stream();
        }

        let currentFile = null;
        function handleJson(msg) {
            if (msg.type === 'chat') log('REMOTE', msg.data);
            if (msg.type === 'meta') {
                currentFile = { ...msg, chunks: [], received: 0 };
                uiCreate(msg.name, msg.id, true);
                stats.start = Date.now();
                stats.bytes = 0;
            }
            if (msg.type === 'end') {
                const url = URL.createObjectURL(new Blob(currentFile.chunks));
                const a = document.getElementById('dl-' + currentFile.id);
                a.href = url;
                a.download = currentFile.name;
                a.classList.remove('hidden');
                currentFile = null;
            }
        }

        function processBytes(buf) {
            if (!currentFile) return;
            currentFile.chunks.push(buf);
            currentFile.received += buf.byteLength;
            stats.bytes += buf.byteLength;
            uiUpdate(currentFile.id, (currentFile.received / currentFile.size) * 100);
            updateSpeed();
        }

        // --- INTERFACE ---
        function nav(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            if(window.innerWidth < 1024) toggleMenu();
        }

        function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }
        document.getElementById('menu-toggle').onclick = toggleMenu;

        function log(who, msg) {
            const out = document.getElementById('chat-messages');
            out.innerHTML += `<div><span class="text-white opacity-40">[${who}]</span> ${msg}</div>`;
            out.scrollTop = out.scrollHeight;
        }

        function uiCreate(name, id) {
            const list = document.getElementById('tx-log');
            list.innerHTML = `
                <div class="p-4 border border-[#00ffaa33] bg-black">
                    <div class="flex justify-between text-[10px] mb-2"><span>${name}</span><span id="p-${id}">0%</span></div>
                    <div class="w-full bg-[#00ffaa11] h-1"><div id="b-${id}" class="h-full bg-[#00ffaa] w-0"></div></div>
                    <a id="dl-${id}" class="hidden block text-center bg-white text-black text-[9px] font-bold mt-3 py-1 uppercase tracking-widest">Download Binary</a>
                </div>
            ` + list.innerHTML;
        }

        function uiUpdate(id, p) {
            const b = document.getElementById('b-' + id);
            if(b) b.style.width = p + '%';
            document.getElementById('p-' + id).innerText = Math.floor(p) + '%';
        }

        function updateSpeed() {
            const elapsed = (Date.now() - stats.start) / 1000;
            if (elapsed > 0.5) {
                const mbps = ((stats.bytes / 1024 / 1024) / elapsed).toFixed(2);
                document.getElementById('stat-speed').innerText = mbps;
            }
        }

        document.getElementById('connect-btn').onclick = () => {
            const tid = document.getElementById('target-id').value.toUpperCase();
            if(tid) setupBridge(peer.connect('TITAN5-' + tid, { reliable: true }));
        };

        document.getElementById('chat-form').onsubmit = e => {
            e.preventDefault();
            const val = document.getElementById('chat-input').value;
            if (val && conn?.open) {
                conn.send({ type: 'chat', data: val });
                log('LOCAL', val);
                document.getElementById('chat-input').value = '';
            }
        };

        document.getElementById('drop-zone').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = e => { if(e.target.files[0]) sendFile(e.target.files[0]); };

        init();
    </script>
</body>
</html>
